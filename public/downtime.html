<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Pie Chart Example</title>
    <meta charset="UTF-8">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
	<link rel="stylesheet" type="text/css" href="https://unpkg.com/dc@3/dc.css" />
	<script src="https://unpkg.com/d3@5/dist/d3.js"></script>
	<script src="https://unpkg.com/crossfilter2@1.4/crossfilter.js"></script>
	<script src="https://unpkg.com/dc@3/dc.js"></script>
	<script src="https://rawgit.com/crossfilter/reductio/master/reductio.js"></script>
	<script src="https://npmcdn.com/universe@latest/universe.js"></script>
	<style>
	.dc-chart g {
		fill: white;
		font-size: 25px;
	}
		
	.dc-chart g.tick text {
		fill: white;
		font-size:20px;
	}
	
	body{
    position: fixed; 
    width: 100%;
	}
	</style>
</head>


<body style="background-color:#303030;color:white">
		<h1>
		<div class="row">
			<div class="col" style="margin-left:1%">Downtime</div>
			<div class="col text-right" style="margin-right:1%">XX/XX/XXXX</div>
		</div>
		</h1>
		<hr style="border-color:white">
	<div class="row">
			<div class="col-md-6 border-right">

				<div class="container" style="margin-top:2%;margin-bottom:5%">
					<div style="margin-left:5%" id="downpie"></div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="row" style="margin-top:2%">
					<table class="table table-striped table-dark" id="downtable"></table>
				</div>
			</div>
	</div>
	
	<hr style="border-color:white;height:10px;background-color:white">
	
	<div class="row">
		<div class="col-md-6">
			<div class="container" style="margin-top:7%;margin-bottom:5%">
				<div style="margin-left:1%"id="downscheduledbar"></div>
			</div> 
		</div>
		<div class="col-md-6">
		<div class="container" style="margin-top:7%;margin-bottom:5%">
			<div style="margin-left:1%" id="downunscheduledbar"></div>
		</div>
		</div>
	</div>



<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>					
<script type="text/javascript">
var downPie = dc.pieChart("#downpie");
var unschdBarchart = dc.barChart("#downunscheduledbar");
var schdBarchart = dc.barChart("#downscheduledbar");
var dataTable = dc.dataTable("#downtable");


d3.csv("data/machinedown.csv").then(function(experiments) {

  experiments.forEach(function(x) {
        x.Speed = +x.Speed;
      });
	  
  var pindx           = crossfilter(experiments),
      pirunDimension  = pindx.dimension(function(d) {return "time-"+d.Run;})
	  pispeedSumGroup = pirunDimension.group().reduceSum(function(d) {return d.Speed * d.Run;});
	  
	  unschdBarndx                 = crossfilter(experiments),
      unschdBarrunDimension        = unschdBarndx.dimension(function(d) {return +d.Run;}),
      unschdBarspeedSumGroup       = unschdBarrunDimension.group().reduceSum(function(d) {return d.Speed * d.Run / 1000;});
	  
	  schdBarndx                 = crossfilter(experiments),
      schdBarrunDimension        = schdBarndx.dimension(function(d) {return +d.Run;}),
      schdBarspeedSumGroup       = schdBarrunDimension.group().reduceSum(function(d) {return d.Speed * d.Run / 1000;});

	  ndx              = crossfilter(experiments),
      exptDimension    = ndx.dimension(function(d) {return +d.Expt;}),
      groupedDimension = exptDimension.group().reduce(
          function (p, v) {
              ++p.number;
              p.total += +v.Speed;
              p.avg = Math.round(p.total / p.number);
              return p;
          },
          function (p, v) {
              --p.number;
              p.total -= +v.Speed;
              p.avg = (p.number == 0) ? 0 : Math.round(p.total / p.number);
              return p;
          },
          function () {
              return {number: 0, total: 0, avg: 0}
      }),
      rank = function (p) { return "" };
	
  downPie
	.colors(d3.scaleOrdinal().range(['#000000','#000033','#000066','#000099','#0000CC','#0000FF']))
    .width(850)
    .height(400)
    .slicesCap(4)
	.cx(300)
    .innerRadius(100)
    .dimension(pirunDimension)
	.legend(dc.legend().x(650).y(25).itemHeight(35).gap(35))
    .group(pispeedSumGroup)
    .on('pretransition', function(downPie) {
        downPie.selectAll('text.pie-slice').text(function(d) {
            return d.data.key + ' ' + dc.utils.printSingleValue((d.endAngle - d.startAngle) / (2*Math.PI) * 100) + '%';
        })
		downPie.selectAll('.dc-legend-item text')	<!--customization of legend object is in "pretransition"
		.attr('dy', '3')							<!-- make labels aligned with legend square indicators
		.attr('dx','15');							<!-- makes some space between legend square indicator and labels.
		downPie.select('g')
		.append("text")
		.attr("text-anchor", "middle")
		.text("Downtime Value")
		.append("br")
		downPie.select('g')
		.append("text")
		.attr("text-anchor", "middle")
		.attr("dy","30")
		.text("(%)")
	    });
	
	unschdBarchart
		.colors(d3.scaleOrdinal().range(['#0000FF']))
		.width(900)
        .height(400)
		.gap(20)
		.x(d3.scaleLinear().domain([6,20]))
		<!--.x(d3.scaleBand()) <!--for single bar select
		<!--.xUnits(dc.units.ordinal) <!-- for single bar select
        .brushOn(false) <!-- allows time range select -->
        .yAxisLabel("This is the Y Axis!")
		.margins({top: 10, right: 20, bottom: 50, left: 30})
        .xAxisLabel('Unscheduled Downtime')
        .dimension(unschdBarrunDimension)
        .group(unschdBarspeedSumGroup)
		.controlsUseVisibility(true)
		.renderlet(function (unschdBarchart) {		<!-- customization of bar chart is in "renderlet"
					unschdBarchart.selectAll("svg")<!-- customize element SVG (Mainframe) first
                      .attr('height', '450')<!--By default, Y axis label overlaps y-axis scale. This fixes the problem and allows additional space for eyegasm.
					  .attr('width','1100') <!--By default, Y axis label overlaps y-axis scale. This fixes the problem and allows additional space for eyegasm.
					unschdBarchart.select("g") <!-- customize element G, area where graph is drawn in
                      .attr('transform', 'translate(0,30)') <!-- SVG controls the area the graph is drawn in (Starting from top left), while G itself is the whole of the graph. Translate the graph downwards makes room for labels.
					unschdBarchart.selectAll("g text.x-axis-label") <!-- adjust x-axis-label positioning, debuggable in "inspect element"
                      .attr('dy', '20')
                    unschdBarchart.selectAll("g text.y-axis-label.y-label") <!-- adjust y-axis-label positioning, debuggable in "inspect element"
                      .attr('dy', '-10')
					  .attr('dx', '25')
                      .attr('transform', "rotate(0)")
					  .attr('text-anchor',"top")
					})

	schdBarchart
		.colors(d3.scaleOrdinal().range(['#0000FF']))
        .width(900)
        .height(400)
		.gap(20)
        .x(d3.scaleLinear().domain([6,20]))
		.margins({top: 10, right: 20, bottom: 50, left: 30})
        .brushOn(false)
        .yAxisLabel("This is the Y Axis!")
		.xAxisLabel("Scheduled Downtime")
        .dimension(unschdBarrunDimension)
		.renderlet(function (schdBarchart) {
					schdBarchart.selectAll("svg") <!-- customize SVG Mainframe first
                      .attr('height', '450')<!--By default, Y axis label overlaps y-axis scale. This fixes the problem and allows additional space for eyegasm.
					  .attr('width','1100') <!--By default, Y axis label overlaps y-axis scale. This fixes the problem and allows additional space for eyegasm.
					schdBarchart.select("g")	<!-- customize g, full area of graph.
                      .attr('transform', 'translate(0,30)') <!-- SVG controls the area the graph is drawn in (Starting from top left), while G itself is the whole of the graph. Translate the graph downwards makes room for labels.
					schdBarchart.selectAll("g text.x-axis-label")
                      .attr('dy', '20')
					schdBarchart.selectAll("g.axis.y")
                      .attr('transform', 'translate(30,10)')
                    schdBarchart.selectAll("g text.y-axis-label.y-label")
                      .attr('dy', '-10')
					  .attr('dx', '25')
                      .attr('transform', "rotate(0)")
					  .attr('text-anchor',"top")
                })
        .group(schdBarspeedSumGroup)
        .on('renderlet', function(schdBarchart) { <!-- allows to click on a bar for a function, clicking is logged in console.
            schdBarchart.selectAll('rect').on("click", function(d) {
                console.log("click!", d);
            });
        });
		
	dataTable
    .width(900)
    .height(480)
    .dimension(groupedDimension)
    .group(rank)
	.renderlet(function (dataTable) {
		dataTable.selectAll("tbody")
                      .attr('style', 'font-size:23px;text-align: center;')
		dataTable.select("td.dc-table-label")
                      .attr('style', 'display:none')
		dataTable.selectAll("th.dc-table-head")
                      .attr('style', 'font-size:25px;width:33%;text-align:center;')
                })
    .columns([
	{label:'Expt', format: function (d) { return d.key },},
    {label:'#Run',format: function (d) { return d.value.number },},
    {label:'Avg(Speed)',format: function (d) { return d.value.avg }}])
    .sortBy(function (d) { return d.value.avg })
    .order(d3.descending)
	
	
  dataTable.render();
  schdBarchart.render();
  unschdBarchart.render();
  downPie.render();
		
});
</script>

</body>
</html>